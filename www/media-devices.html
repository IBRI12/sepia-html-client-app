<div id='sepiaFW-frame-carousel' class="sepiaFW-inner-container sepiaFW-carousel">
	<div class='sepiaFW-carousel-pane-container'>
		<!-- Page 1 -->
		<div id="sepiaFW-frame-page-1" class='sepiaFW-frames-page sepiaFW-carousel-pane'>
			<h3>Media Devices Settings</h3>
			<p class="info-text">Here you can configure the media devices like microphone and audio sources (speakers) of your device.</p>
			<div id="sepiaFW-media-devices-settings" class="group-container">
				<div class="group" style="justify-content: center;">
					<button id="SepiaFW-media-devices-refresh" onclick="SepiaFW.frames.currentScope.refreshDevices()">Refresh devices</button>
					<button id="SepiaFW-media-devices-store" onclick="SepiaFW.frames.currentScope.store()">Store settings</button>
					<button id="SepiaFW-media-devices-default" onclick="SepiaFW.frames.currentScope.resetToDefault()">Default</button>
				</div>
				<h3>Speakers</h3>
				<div class="group">
					<label>Audio player output:</label>
					<div id="sepiaFW-media-devices-audio-player-box"></div>
				</div>
				<div class="group">
					<label>TTS output:</label>
					<div id="sepiaFW-media-devices-tts-player-box"></div>
				</div>
				<div class="group">
					<label>FX output:</label>
					<div id="sepiaFW-media-devices-fx-player-box"></div>
				</div>
				<h3>Microphone</h3>
				<div class="group">
					<label>Microphone input:</label>
					<div id="sepiaFW-media-devices-mic-box"></div>
				</div>
				<h3>Info</h3>
				<div id="sepiaFW-media-devices-info-msg" style="white-space: break-spaces;"></div>
			</div>
		</div>
	</div>
</div>
<div id="sepiaFW-frames-nav-bar" class='sepiaFW-layer-header'>
	<button id="sepiaFW-frames-close" class='entry'>
		<i class="material-icons md-btn2">&#xE5CD;</i>
	</button>
	<!--<button id="sepiaFW-frames-show-prev-page" class='entry'>
		<i class="material-icons md-btn2">keyboard_arrow_left</i><span data-localize="back">back</span>
	</button>
	<button id="sepiaFW-frames-show-next-page" class='entry'>
		<span data-localize="next">next</span><i class="material-icons md-btn2">keyboard_arrow_right</i>
	</button>-->
	<div id="sepiaFW-frames-nav-bar-page-indicator"><div>&nbsp;</div></div>
</div>
<script>
	$('#sepiaFW-frame-carousel').find('[data-localize]').each(function(){
		$(this).html(SepiaFW.local.g(this.dataset.localize));
	});
	
	//Define scope
	SepiaFW.frames.currentScope = {

		onFinishSetup: function(){
			SepiaFW.frames.currentScope.refreshDevices();
		},
		
		onOpen: function(){
			$('#sepiaFW-media-devices-mic').val(SepiaFW.audio.mediaDevicesSelected["mic"].value);
			$('#sepiaFW-media-devices-audio-player').val(SepiaFW.audio.mediaDevicesSelected["player"].value);
			$('#sepiaFW-media-devices-tts-player').val(SepiaFW.audio.mediaDevicesSelected["tts"].value);
			$('#sepiaFW-media-devices-fx-player').val(SepiaFW.audio.mediaDevicesSelected["fx"].value);
		},
		
		refreshDevices: function(){
			SepiaFW.frames.currentScope.showInfo("Loading devices...");
			SepiaFW.audio.refreshAvailableMediaDevices(function(mediaDevicesAvailable){
				SepiaFW.frames.currentScope.updateSelectors();
				var logMsg = "Found devices:\n\n" 
					+ "Input: " + (Object.keys(mediaDevicesAvailable.in).length) + "\n"
					+ "Output: " + (Object.keys(mediaDevicesAvailable.in).length) + "\n"
					+ '\nPlease note that the "same" device can show up with multiple names.';
				SepiaFW.frames.currentScope.showInfo(logMsg);
			}, function(err){
				SepiaFW.debug.error("Media-Devices - failed to load devices:", err);
				SepiaFW.frames.currentScope.showError(err.message);
			});
		},
		
		updateSelectors: function(){
			var micEle = document.getElementById('sepiaFW-media-devices-mic-box');
			var playerEle = document.getElementById('sepiaFW-media-devices-audio-player-box');
			var ttsEle = document.getElementById('sepiaFW-media-devices-tts-player-box');
			var fxEle = document.getElementById('sepiaFW-media-devices-fx-player-box');
			
			micEle.innerHTML = "";
			playerEle.innerHTML = "";
			ttsEle.innerHTML = "";
			fxEle.innerHTML = "";
			
			var inOptions = [{value: "", name: "Default"}];
			Object.keys(SepiaFW.audio.mediaDevicesAvailable.in).forEach(function(label){
				var deviceId = SepiaFW.audio.mediaDevicesAvailable.in[label];
				inOptions.push({
					value: deviceId,
					name: label
				});
			});
			micEle.appendChild(SepiaFW.ui.build.optionSelector(
				"sepiaFW-media-devices-mic", inOptions, SepiaFW.audio.mediaDevicesSelected["mic"].value, function(ele){
					SepiaFW.frames.currentScope.setMediaSink("mic", ele.selectedOptions[0].textContent, ele.value);
				}
			));
			
			var outOptions = [{value: "", name: "Default"}];
			Object.keys(SepiaFW.audio.mediaDevicesAvailable.out).forEach(function(label){
				var deviceId = SepiaFW.audio.mediaDevicesAvailable.out[label];
				outOptions.push({
					value: deviceId,
					name: label
				});
			});
			playerEle.appendChild(SepiaFW.ui.build.optionSelector(
				"sepiaFW-media-devices-audio-player", outOptions, SepiaFW.audio.mediaDevicesSelected["player"].value, function(ele){
					SepiaFW.frames.currentScope.setMediaSink("player", ele.selectedOptions[0].textContent, ele.value);
				}
			));
			ttsEle.appendChild(SepiaFW.ui.build.optionSelector(
				"sepiaFW-media-devices-tts-player", outOptions, SepiaFW.audio.mediaDevicesSelected["tts"].value, function(ele){
					SepiaFW.frames.currentScope.setMediaSink("tts", ele.selectedOptions[0].textContent, ele.value);
				}
			));
			fxEle.appendChild(SepiaFW.ui.build.optionSelector(
				"sepiaFW-media-devices-fx-player", outOptions, SepiaFW.audio.mediaDevicesSelected["fx"].value, function(ele){
					SepiaFW.frames.currentScope.setMediaSink("fx", ele.selectedOptions[0].textContent, ele.value);
				}
			));
		},

		setMediaSink: function(mediaNodeType, mediaDeviceLabel, mediaDeviceId){
			//console.log(mediaNodeType, mediaDeviceLabel, mediaDeviceId); 		//DEBUG
			SepiaFW.audio.setMediaDeviceForNode(mediaNodeType, {deviceId: mediaDeviceId, label: mediaDeviceLabel}, 
				function(){
					//DONE
					SepiaFW.debug.log("Media-Devices - set device sink for '" + mediaNodeType + "' to (label): " + mediaDeviceLabel);
					//SepiaFW.frames.currentScope.showInfo("Success - Set device for type '" + mediaNodeType + "' to: " + mediaDeviceLabel);
				}, function(err){
					//FAIL
					SepiaFW.debug.error("Media-Devices - failed to set device sink for '" + mediaNodeType + "':", err);
					SepiaFW.frames.currentScope.showError("Failed to set device for '" + mediaNodeType + "' - " + err);
				}
			);
		},
		
		store: function(){
			SepiaFW.audio.storeMediaDevicesSetting();
			SepiaFW.ui.showPopup("Settings stored.");		//SepiaFW.local.g("...")
		},
		resetToDefault: function(){
			SepiaFW.audio.resetMediaDevicesSetting();
			SepiaFW.ui.showPopup("Reset settings, please reload client.");
		},

		showInfo: function(msg){
			$('#sepiaFW-media-devices-info-msg').css("color", "").text(msg);
		},
		showError: function(msg){
			$('#sepiaFW-media-devices-info-msg').css("color", "#f00").text(msg);
		}
	}
</script>